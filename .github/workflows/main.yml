name: Python Django Exercise CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      DB_USER: user
      DB_PASSWORD: password
      DB_NAME: mock_db
      DB_HOST: postgres
      DB_PORT: 5432

    steps:
      - uses: actions/checkout@v2

      - name: Build the Docker image
        run: docker-compose build

      - name: Run tests
        run: docker-compose run web python manage.py test

  build:
    name: Build & Deploy
    needs: test 
    runs-on: ubuntu-latest
    environment:
      name: staging
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: "google-github-actions/auth@v1"
        name: Google Cloud Auth
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - name: Configure docker for pushing
        run: gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev

      - name: Build the Docker image
        run: |
          docker build -t ${{ vars.IMAGE_NAME }}:latest ./blog_platform

      - name: Deploy to GCP Artifact Registry
        run: |
          docker tag ${{ vars.IMAGE_NAME }}:latest ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_NAME }}/${{ vars.REPOSITORY }}/${{ vars.IMAGE_NAME }}:latest
          docker push ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_NAME }}/${{ vars.REPOSITORY }}/${{ vars.IMAGE_NAME }}:latest